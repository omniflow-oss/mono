#!/usr/bin/env bash
set -euo pipefail

# Welcome message for new contributors
if [[ ! -d "node_modules" ]]; then
  echo ""
  echo "⚠️  Dependencies not installed"
  echo "   Run: ./mono bootstrap"
  echo ""
fi

MONO_IN_DOCKER=${MONO_IN_DOCKER:-1}

if [[ "${1:-}" == "--native" ]]; then
  MONO_IN_DOCKER=0
  shift
fi

if [[ "${1:-}" == infra || "${1:-}" == infra:* ]]; then
  subcmd="${1#infra:}"
  if [[ "${1:-}" == infra ]]; then
    subcmd="up"
  fi
  if [[ "$subcmd" == "up" ]]; then
    docker compose -f infra/tools.compose.yaml up -d
    exit $?
  fi
  if [[ "$subcmd" == "down" ]]; then
    docker compose -f infra/tools.compose.yaml down
    exit $?
  fi
fi

if [[ "$MONO_IN_DOCKER" == "1" ]]; then
  export USER_ID=$(id -u)
  export GROUP_ID=$(id -g)
  docker compose -f infra/tools.compose.yaml run --rm tools node tools/mono.mjs "$@"
else
  node tools/mono.mjs "$@"
fi
