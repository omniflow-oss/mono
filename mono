#!/usr/bin/env bash
set -euo pipefail

# Welcome message for new contributors
if [[ ! -d "node_modules" ]]; then
  echo ""
  echo "⚠️  Dependencies not installed"
  echo "   Run: ./mono bootstrap"
  echo ""
fi

MONO_IN_DOCKER=${MONO_IN_DOCKER:-1}

if [[ "${1:-}" == "--native" ]]; then
  echo "Docker is required; --native is not supported"
  exit 1
fi

if [[ "${1:-}" == infra || "${1:-}" == infra:* ]]; then
  subcmd="${1#infra:}"
  if [[ "${1:-}" == infra ]]; then
    subcmd="up"
  fi
  if [[ "$subcmd" == "up" ]]; then
    docker compose -f infra/tools.compose.yaml up -d
    exit $?
  fi
  if [[ "$subcmd" == "down" ]]; then
    docker compose -f infra/tools.compose.yaml down
    exit $?
  fi
fi

if [[ "$MONO_IN_DOCKER" == "1" ]]; then
  if ! command -v docker >/dev/null 2>&1; then
    echo "Docker is required but not installed"
    exit 1
  fi
  export USER_ID=$(id -u)
  export GROUP_ID=$(id -g)
  docker compose -f infra/tools.compose.yaml run --rm tools node tools/mono.mjs "$@"
else
  echo "Docker is required; set MONO_IN_DOCKER=1"
  exit 1
fi
